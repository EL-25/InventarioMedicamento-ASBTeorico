@{
    ViewData["Title"] = "Registrar Venta";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<style>
    body {
        font-family: 'Segoe UI', sans-serif;
        background: linear-gradient(to right, #004e92, #000428);
        padding: 40px;
        color: #fff;
    }

    .venta-card {
        background-color: rgba(0, 0, 0, 0.5);
        border-radius: 15px;
        padding: 25px;
        width: 90%;
        margin: 0 auto;
        box-shadow: 0 0 20px rgba(0,0,0,0.4);
    }

    label, input, select {
        display: block;
        margin-bottom: 15px;
        width: 100%;
        color: #fff;
    }

    input, select {
        padding: 8px;
        border-radius: 5px;
        border: none;
        background-color: #222;
        color: #00ffff;
    }

    .btn-submit {
        background-color: #00ffff;
        color: #000;
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
        margin-top: 20px;
    }

    table {
        width: 100%;
        margin-top: 20px;
        border-collapse: collapse;
        background-color: rgba(0,0,0,0.6);
    }

    th, td {
        padding: 10px;
        border-bottom: 1px solid #00ffff;
        text-align: left;
        color: #fff;
    }

    th {
        background-color: #00ffff;
        color: #000;
    }

    .total-box {
        text-align: right;
        font-size: 1.2rem;
        margin-top: 20px;
        color: #00ffff;
    }
</style>

<div class="venta-card">
    <h2 style="text-align:center; color:#00ffff;">Formulario de Venta</h2>

    <div>
        <label for="medicamento">Medicamento</label>
        <select id="medicamento" style="width:100%;">
            <option value="">-- Seleccione --</option>
            @foreach (var lote in ViewBag.LotesConStock)
            {
                <option value="@lote.id_lote"
                        data-idmed="@lote.id_medicamento"
                        data-nombre="@lote.nombre_medicamento"
                        data-stock="@lote.stock_disponible">
                    @lote.nombre_medicamento (@lote.presentacion) - Stock: @lote.stock_disponible
                </option>
            }
        </select>

        <label for="cantidad">Cantidad</label>
        <input type="number" id="cantidad" min="1" />

        <label for="precio">Precio Unitario</label>
        <input type="number" id="precio" step="0.01" min="0" />

        <button type="button" class="btn-submit" onclick="agregarProducto()">Agregar al carrito</button>
    </div>

    <table id="tablaVenta">
        <thead>
            <tr>
                <th>Medicamento</th>
                <th>Cantidad</th>
                <th>Precio Unitario</th>
                <th>Subtotal</th>
                <th>Acción</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <div class="total-box">
        Total: $<span id="totalGeneral">0.00</span>
    </div>

    <form asp-action="RegistrarVenta" method="post" id="formVenta">
        <input type="hidden" name="ventasJson" id="ventasJson" />
        <button type="submit" class="btn-submit">Confirmar Venta</button>
    </form>
</div>

<script>
    $(document).ready(function () {
        $('#medicamento').select2();
    });

    let carrito = [];

    function agregarProducto() {
        const select = document.getElementById("medicamento");
        const id_lote = parseInt(select.value);
        const id_medicamento = parseInt(select.options[select.selectedIndex].getAttribute("data-idmed"));
        const nombre = select.options[select.selectedIndex].getAttribute("data-nombre");
        const stock = parseInt(select.options[select.selectedIndex].getAttribute("data-stock"));
        const cantidad = parseInt(document.getElementById("cantidad").value);
        const precio = parseFloat(document.getElementById("precio").value);

        if (isNaN(id_lote) || isNaN(id_medicamento) || isNaN(cantidad) || isNaN(precio) || cantidad <= 0 || precio <= 0) {
            alert("Complete todos los campos correctamente.");
            return;
        }

        if (cantidad > stock) {
            alert(`Stock insuficiente. Disponible: ${stock}`);
            return;
        }

        const subtotal = cantidad * precio;
        carrito.push({
            id_medicamento: id_medicamento,
            id_lote: id_lote,
            nombre_medicamento: nombre,
            cantidad: cantidad,
            precio_unitario: precio,
            subtotal: subtotal
        });

        actualizarTabla();
        actualizarTotal();
        limpiarCampos();
    }

    function actualizarTabla() {
        const tbody = document.querySelector("#tablaVenta tbody");
        tbody.innerHTML = "";

        carrito.forEach((item, index) => {
            const fila = `<tr>
                <td>${item.nombre_medicamento}</td>
                <td>${item.cantidad}</td>
                <td>$${item.precio_unitario.toFixed(2)}</td>
                <td>$${item.subtotal.toFixed(2)}</td>
                <td><button type="button" onclick="eliminarProducto(${index})">Eliminar</button></td>
            </tr>`;
            tbody.innerHTML += fila;
        });

        document.getElementById("ventasJson").value = JSON.stringify(carrito);
    }

    function actualizarTotal() {
        const total = carrito.reduce((acc, item) => acc + item.subtotal, 0);
        document.getElementById("totalGeneral").innerText = total.toFixed(2);
    }

    function eliminarProducto(index) {
        carrito.splice(index, 1);
        actualizarTabla();
        actualizarTotal();
    }

    function limpiarCampos() {
        document.getElementById("cantidad").value = "";
        document.getElementById("precio").value = "";
        $('#medicamento').val(null).trigger('change');
    }
</script>
